<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sitzordnung</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="styles.css">
  <script>
    const STUDENTS = [
      { "id": 123, "name": "Arnoldl", "firstname": "Ella", "cls": "2ES", "lang": "de" },
      { "id": 124, "name": "Arnulf", "firstname": "Ella", "cls": "2ES", "lang": "fr" },
      { "id": 125, "name": "Chapmanx", "firstname": "Brandon", "cls": "2ES", "lang": "de" },
      { "id": 126, "name": "Colemans", "firstname": "Carl", "cls": "2ES", "lang": "de" },
      { "id": 127, "name": "Cornishw", "firstname": "Hilda", "cls": "2ES", "lang": "fr" },
      { "id": 128, "name": "Dowdy", "firstname": "Emma", "cls": "2ES", "lang": "fr" },
      { "id": 129, "name": "Unhold", "firstname": "Ella", "cls": "2ES", "lang": "fr" },
      { "id": 130, "name": "Grossartigh", "firstname": "Arthur", "cls": "2ES", "lang": "de" },
      { "id": 131, "name": "Guintardt", "firstname": "Gavin", "cls": "2ES", "lang": "fr" },
      { "id": 132, "name": "Herforderlichu", "firstname": "Jacob", "cls": "2ES", "lang": "fr" },
      { "id": 133, "name": "Hilll", "firstname": "Sophie", "cls": "2ES", "lang": "fr" },
      { "id": 134, "name": "Kremerlangi", "firstname": "Jason", "cls": "2ES", "lang": "fr" },
      { "id": 135, "name": "Langdona", "firstname": "Sam", "cls": "2ES", "lang": "fr" },
      { "id": 136, "name": "Manningr", "firstname": "Christopherus-Maxime", "cls": "2ES", "lang": "fr" },
      { "id": 137, "name": "McLeanh", "firstname": "Paul", "cls": "2ES", "lang": "fr" },
      { "id": 138, "name": "Perez", "firstname": "Penelope", "cls": "2ES", "lang": "fr" },
      { "id": 139, "name": "Pooler", "firstname": "Nicola", "cls": "2ES", "lang": "de" },
      { "id": 140, "name": "Randallw", "firstname": "Fiona", "cls": "2ES", "lang": "fr" },
      { "id": 141, "name": "Parsonse", "firstname": "Penelope", "cls": "2ES", "lang": "fr" },
      { "id": 142, "name": "Hausmann", "firstname": "Jacob", "cls": "2ES", "lang": "fr" },
      { "id": 143, "name": "Maier", "firstname": "Heinz", "cls": "2ES", "lang": "fr" },
      { "id": 144, "name": "Müller", "firstname": "Bertram", "cls": "2ES", "lang": "fr" },
      { "id": 145, "name": "Gauß", "firstname": "Carl Friedrich", "cls": "2ES", "lang": "fr" },
    ];

    addShortnames();
    
    const studentMap = {};
    STUDENTS.forEach(s => {
      studentMap[s.id] = s;
    });

    CONFIG = {
      showLastnames: true,
      teachersView: true,
      rows: Math.ceil(STUDENTS.length / 8),
      columns: 8
    };

    const MAX_ROWS = 6;
    const MAX_COLUMNS = 12;

    let grid = [];
    let gaps = [];
    let changed = [];
    let unseated = [];
    let firstClickedStudentId = null;

    function toggleView() {
      CONFIG.teachersView = !CONFIG.teachersView;
      renderGrid();
    }

    function addShortnames() {
      // set fullnames for comparison
      for (const s of STUDENTS) {
        s.fullname = s.firstname + " " + s.name;
      }

      for (const s of STUDENTS) {
        for (let i = s.firstname.length; i < s.fullname.length; i++) {
          // check incrementally longer names for uniqueness
          const candidate = s.fullname.slice(0, i);
          if (STUDENTS.filter(s2 => s.id != s2.id && s2.fullname.startsWith(candidate)).length === 0) {
            s.shortname = i > s.firstname.length ? candidate + "." : candidate.trim();
            break;
          }
        }

        if (!s.shortname) {
          s.shortname = s.fullname;
        }
      }
    }

    function rebuildGrid(keepSeatedStudents) {
      const newGrid = [];
      for (let i = 0; i < CONFIG.rows; i++) {
        const row = [];
        for (let j = 0; j < CONFIG.columns; j++) {
          const elemId = i + "_" + j;
          row.push({
            id: elemId,
            studentId: keepSeatedStudents ? grid[i]?.[j]?.studentId : null
          });
        }
        newGrid.push(row);
      }

      grid = newGrid;
      checkButtons();
      renderGrid();
    }

    function checkButtons() {
      $("#deleteRow").prop("disabled", (CONFIG.rows - 1) * CONFIG.columns < STUDENTS.length);
      $("#addRow").prop("disabled", CONFIG.rows >= MAX_ROWS);
      $("#deleteColumn").prop("disabled", CONFIG.rows * (CONFIG.columns - 1) < STUDENTS.length);
      $("#addColumn").prop("disabled", CONFIG.columns >= MAX_COLUMNS);
    }

    function renderGrid() {
      const classRoom = $("#classroom");
      classRoom.empty();

      const directionCls = CONFIG.teachersView ? "flex-column-reverse" : "flex-column";
      const container = $("<div>", {
        class: `d-flex justify-center align-content-center align-items-center m-5 ${directionCls}`
      });
      classRoom.append(container);

      // Teacher node
      const $el = $('<div>', {
        class: 'justify-center border border-dark w-25 text-center py-3 my-2',
        text: 'Herr Charra',
        id: 'teacher'
      });
      container.append($el);

      // Grid nodes
      for (let rowIdx = 0; rowIdx < grid.length; rowIdx++) {
        const row = grid[rowIdx];
        const rowDirectionCls = CONFIG.teachersView ? "flex-row-reverse" : "flex-row";
        let rowElem = $('<div>', {
          class: "m-3 d-flex align-items-start " + rowDirectionCls,
        });

        for (let colIdx = 0; colIdx < row.length; colIdx++) {
          const seat = row[colIdx];
          let cssClasses = "seat border border-dark text-center px-1 d-inline-block align-items-center align-content-center";
          let seatText = "";

          if (seat.studentId) {
            const student = studentMap[seat.studentId];
            seatText = `${student.shortname}<br> (${student.cls})`;

            if (seat.studentId === firstClickedStudentId) {
              cssClasses += " highlighted";
            }

            if (changed.indexOf(seat.studentId) > -1) {
              cssClasses += " changed";
            }
          }

          $('<div>', {
            class: cssClasses,
            id: seat.id,
            html: seatText
          }).appendTo(rowElem);

          if (colIdx < row.length - 1) {
            $('<div>', {
              class: gaps.indexOf(seat.id) === -1 ? "gap" : "gap gap_active"
            })
              .on("click", () => toggleGap(seat.id))
              .appendTo(rowElem);
          }
        };

        container.append(rowElem);
      }
      
      unseated = getUnseatedStudents();
      unseated.sort((a, b) => studentMap[a].shortname.localeCompare(studentMap[b].shortname));
      const unseatedElem = $("#unseated");
      unseatedElem.empty();
      for (const [idx, studentId] of unseated.entries()) {
        let cssClasses = "seat border border-dark text-center px-1 mb-2 mr-2 align-items-center align-content-center";
        if (firstClickedStudentId === studentId) {
          cssClasses += " highlighted";
        }
        if (changed.indexOf(studentId) > -1) {
          cssClasses += " changed";
        }
        
        $('<div>', {
          class: cssClasses,
          id: "u_" + idx,
          html: studentMap[studentId].shortname
        }).appendTo(unseatedElem);
      }

      // reset to empty list
      changed = [];

      $(".seat").off("click");
      $(".seat").on("click", (e) => onSelect(e.target.id));
    }

    function toggleGap(seatId) {
      if (gaps.indexOf(seatId) > -1) {
        gaps = gaps.filter(g => g !== seatId);
      } else {
        gaps.push(seatId);
      }
      renderGrid();
    }

    function fillUnseatedStudents() {
      const unseated = getUnseatedStudents();
      for (const id of unseated) {
        let attempts = 0;
        while (attempts < 10000) {
          const randRow = Math.floor(Math.random() * CONFIG.rows);
          const randCol = Math.floor(Math.random() * CONFIG.columns);

          if (!grid[randRow][randCol].studentId) {
            grid[randRow][randCol].studentId = id;
            changed.push(id);
            break;
          }
          attempts++;
        }
      }

      renderGrid();
    }

    function changeGrid(deltaRows, deltaCols) {
      CONFIG.rows = Math.min(MAX_ROWS, Math.max(1, CONFIG.rows + deltaRows));
      CONFIG.columns = Math.min(MAX_COLUMNS, Math.max(3, CONFIG.columns + deltaCols));
      rebuildGrid(true);
    }

    function getUnseatedStudents() {
      const ids = STUDENTS.map(s => s.id);
      const seated = [];
      for (let i = 0; i < CONFIG.rows; i++) {
        for (let j = 0; j < CONFIG.columns; j++) {
          if (grid[i][j].studentId) {
            seated.push(grid[i][j].studentId);
          }
        }
      }
      return ids.filter(i => seated.indexOf(i) === -1);
    }

    function findCellWithStudentId(sid) {
      for (let i = 0; i < CONFIG.rows; i++) {
        for (let j = 0; j < CONFIG.columns; j++) {
          if (grid[i][j].studentId === sid) {
            return grid[i][j];
          }
        }
      }
    }

    function onSelect(gridId) {
      let [gridCell, lastClickedStudentId] = [null, null];

      if (gridId.startsWith("u")) {
        const idx = gridId.split("_")[1];
        lastClickedStudentId = unseated[idx];
      } else {
        const [row, col] = gridId.split("_");
        gridCell = grid[row][col];
        lastClickedStudentId = gridCell.studentId;
      }

      // Case 1: First click => select student and return
      if (!firstClickedStudentId) {
        firstClickedStudentId = lastClickedStudentId;
        renderGrid();
        return;
      }

      // Case 2: Second click after selection. Swap/Move selected student.
      const originCell = findCellWithStudentId(firstClickedStudentId);
      if (lastClickedStudentId) {
        // Two clicks on same student => move to bench
        if (lastClickedStudentId === firstClickedStudentId) {
          if (originCell) {
            originCell.studentId = null;
            changed = [lastClickedStudentId];
          }
        } else {
          if (originCell && gridCell) {
            // Swap between two grid cells
            originCell.studentId = gridCell.studentId;
            gridCell.studentId = firstClickedStudentId;
            changed = [lastClickedStudentId, firstClickedStudentId];
          } else if (originCell) {
            // Swap from grid to bench
            originCell.studentId = lastClickedStudentId;
            changed = [lastClickedStudentId, firstClickedStudentId];
          } else if (gridCell) {
            // Swap from bench to grid
            gridCell.studentId = firstClickedStudentId;
            changed = [lastClickedStudentId, firstClickedStudentId];
          } else {
            console.log("Invalid swap");
          }          
        }
      } else {
        if (originCell) {
          originCell.studentId = null;
        }
        gridCell.studentId = firstClickedStudentId;
        changed = [firstClickedStudentId];
      }

      firstClickedStudentId = null;
      renderGrid();
    }

    function clearGrid() {
      rebuildGrid(false);
    }

    function init() {
      rebuildGrid(false);
    }

  </script>
</head>

<body onload="init()">
  <div class="d-flex justify-content-center w-100 my-2">
    <button id="addRow" class="btn btn-primary mx-2 my-1" onclick="changeGrid(1, 0)">Reihe hinzufügen</button>
    <button id="deleteRow" class="btn btn-primary mx-2 my-1" onclick="changeGrid(-1, 0)">Reihe entfernen</button>
    <button id="addColumn" class="btn btn-primary mx-2 my-1" onclick="changeGrid(0, 1)">Spalte hinzufügen</button>
    <button id="deleteColumn" class="btn btn-primary mx-2 my-1" onclick="changeGrid(0, -1)">Spalte entfernen</button>
  </div>

  <div id="classroom">
  </div>

  <div>
    <button class="btn btn-primary mx-2 my-1" onclick="toggleView()">Ansicht wechseln</button>
    <button class="btn btn-primary mx-2 my-1" onclick="fillUnseatedStudents()">Zufällige Verteilung</button>
    <button class="btn btn-warning mx-2 my-1" onclick="clearGrid()">Alle Plätze leeren</button>
  </div>

  <div id="unseated" class="m-3 d-flex flex-wrap align-items-start">
  </div>

</body>

</html>