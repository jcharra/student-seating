<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sitzordnung</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="styles.css">
  <script src="config.js"></script>
  <script>
    let students = [];
    const studentMap = {};

    const MAX_ROWS = 6;
    const MAX_COLUMNS = 12;
    const FLAGS = {
      de: "üá©üá™",
      fr: "üá´üá∑",
      en: "üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø",
      us: "üá∫üá∏",
      es: "üá™üá∏"
    };
    let seatsInRow = [];

    let grid = [];
    let gaps = [];
    let changed = [];
    let unseated = [];
    let firstClickedStudentId = null;
    let teachersView = true;
    
    function init() {
      $.get(API.getStudents, (data) => {
         students = data;
         addShortnames();
         students.forEach(s => {
           studentMap[s.id] = s;
         });
         seatsInRow = Array(Math.ceil(students.length / 8)).fill(8);
         rebuildGrid(false);
      });

      $('.toast').toast({ delay: 1000 });
    }

    function toggleView() {
      teachersView = !teachersView;

      if (teachersView) {
        $("#gridModification, #distribution").removeClass("d-none").addClass("d-flex");
        $("#toggleViewButton").text("Zur Sch√ºleransicht wechseln");
      } else {
        $("#gridModification, #distribution").removeClass("d-flex").addClass("d-none");
        $("#toggleViewButton").text("Zur Lehreransicht wechseln");
      }

      renderGrid();
    }

    function addShortnames() {
      // set fullnames for comparison
      for (const s of students) {
        let fname = s.firstname;
        if (s.firstname.length > 10) {
          if (s.firstname.indexOf("-") > -1) {
            fname = s.firstname.split("-").map(c => c.length > 10 ? c.slice(0, 8) + "." : c).join(" ");
          } else {
            fname = s.firstname.slice(0, 8) + ".";
          }
        }
        s.fullname = fname + " " + s.name;
      }

      for (const s of students) {
        for (let i = s.fullname.lastIndexOf(" "); i < s.fullname.length; i++) {
          // check incrementally longer names for uniqueness
          const candidate = s.fullname.slice(0, i);
          if (students.filter(s2 => s.id != s2.id && s2.fullname.startsWith(candidate)).length === 0) {
            s.shortname = i > s.firstname.length ? candidate + "." : candidate.trim();
            break;
          }
        }

        if (!s.shortname) {
          s.shortname = s.fullname;
        }
      }
    }

    function rebuildGrid(keepSeatedStudents) {
      const newGrid = [];
      for (let i = 0; i < seatsInRow.length; i++) {
        const row = [];
        for (let j = 0; j < seatsInRow[i]; j++) {
          const elemId = i + "_" + j;
          row.push({
            id: elemId,
            studentId: keepSeatedStudents ? grid[i]?.[j]?.studentId : null
          });
        }
        newGrid.push(row);
      }

      grid = newGrid;
      checkButtons();
      renderGrid();
    }

    function checkButtons() {
      const numOfSeatsWithoutLastRow = seatsInRow.slice(0, seatsInRow.length - 1).reduce((acc, value) => acc + value, 0);
      $("#deleteRow").prop("disabled", numOfSeatsWithoutLastRow < students.length);
      $("#addRow").prop("disabled", seatsInRow.length >= MAX_ROWS);
    }

    function renderStudent(sid) {
      if (!sid) return "";
      const s = studentMap[sid];
      return `${s.shortname} <br>${s.cls || ""} ${s.lang ? FLAGS[s.lang] : ""}`;
    }

    function renderGrid() {
      const classRoom = $("#classroom");
      classRoom.empty();

      const directionCls = teachersView ? "flex-column-reverse" : "flex-column";
      const container = $("<div>", {
        class: `d-flex justify-center align-content-center align-items-center m-5 ${directionCls}`
      });
      classRoom.append(container);

      // Teacher node
      const $el = $('<div>', {
        class: 'justify-center border border-dark w-25 text-center py-3 my-2 teacher',
        text: 'Herr Charra',
        id: 'teacher'
      });
      container.append($el);

      // Grid nodes
      for (let rowIdx = 0; rowIdx < grid.length; rowIdx++) {
        const row = grid[rowIdx];
        const rowDirectionCls = teachersView ? "flex-row-reverse" : "flex-row";
        let rowElem = $('<div>', {
          class: "m-3 d-flex align-items-start " + rowDirectionCls,
        });


        for (let colIdx = 0; colIdx < row.length; colIdx++) {
          const seat = row[colIdx];
          let cssClasses = "seat border border-dark text-center px-1 d-inline-block align-items-center align-content-center";
          let seatText = "";

          if (seat.studentId) {
            const student = studentMap[seat.studentId];

            if (seat.studentId === firstClickedStudentId) {
              cssClasses += " highlighted";
            }

            if (changed.indexOf(seat.studentId) > -1) {
              cssClasses += " changed";
            }
          }

          $('<div>', {
            class: cssClasses,
            id: seat.id,
            html: renderStudent(seat.studentId)
          }).appendTo(rowElem);

          if (colIdx < row.length - 1) {
            $('<div>', {
              class: gaps.indexOf(seat.id) === -1 ? "gap" : "gap gap_active"
            })
              .on("click", () => toggleGap(seat.id))
              .appendTo(rowElem);
          }
        }

        if (teachersView) {
          addRemoveButtons = generateAddRemoveButtons(rowIdx);
          addRemoveButtons.appendTo(rowElem);
        }

        container.append(rowElem);
      }

      unseated = getUnseatedStudents();
      unseated.sort((a, b) => studentMap[a].shortname.localeCompare(studentMap[b].shortname));
      const unseatedElem = $("#unseated");
      unseatedElem.empty();
      for (const [idx, studentId] of unseated.entries()) {
        let cssClasses = "seat border border-dark text-center px-1 mb-2 mr-2 align-items-center align-content-center";
        if (firstClickedStudentId === studentId) {
          cssClasses += " highlighted";
        }
        if (changed.indexOf(studentId) > -1) {
          cssClasses += " changed";
        }

        $('<div>', {
          class: cssClasses,
          id: "u_" + idx,
          html: renderStudent(studentId)
        }).appendTo(unseatedElem);
      }

      // reset to empty list
      changed = [];

      $("#clearButton").prop("disabled", unseated.length === 0);

      $(".seat").off("click");
      $(".seat").on("click", (e) => onSelect(e.target.id));
      $(".addButton, .removeButton").off("click");
      $(".addButton, .removeButton").on("click", (e) => onModify(e.target.id));
    }

    function generateAddRemoveButtons(rowIndex, isStart) {
      let html;
      if (isStart) {
        html = `<div class='addButton' id='prepend_${rowIndex}'>+</div><div class='removeButton' id='shift_${rowIndex}'>-</div>`;
      } else {
        html = `<div class='addButton' id='push_${rowIndex}'>+</div><div class='removeButton' id='pop_${rowIndex}'>-</div>`
      }

      return $('<div>', {
        class: "addRemoveButtons",
        html
      });
    }

    function onModify(elemId) {
      const [action, rowIdx] = elemId.split("_");
      if (action === "prepend" || action === "push") {
        seatsInRow[rowIdx]++;
      } else if (action === "shift" || action === "pop") {
        seatsInRow[rowIdx]--;
      } else {
        console.error("Invalid command for elemId " + elemId);
      }
      rebuildGrid(true);
    }

    function toggleGap(seatId) {
      if (gaps.indexOf(seatId) > -1) {
        gaps = gaps.filter(g => g !== seatId);
      } else {
        gaps.push(seatId);
      }
      renderGrid();
    }

    function fillUnseatedStudents() {
      const unseated = getUnseatedStudents();
      for (const id of unseated) {
        let attempts = 0;
        while (attempts < 10000) {
          const randRow = Math.floor(Math.random() * seatsInRow.length);
          const randCol = Math.floor(Math.random() * seatsInRow[randRow]);

          if (!grid[randRow][randCol].studentId) {
            grid[randRow][randCol].studentId = id;
            changed.push(id);
            break;
          }
          attempts++;
        }
      }

      renderGrid();
    }

    function changeRows(deltaRows) {
      if (deltaRows === 1 && seatsInRow.length < MAX_ROWS) {
        // Copy last element to end
        seatsInRow.push(seatsInRow[seatsInRow.length - 1]);
      } else {
        seatsInRow.pop();
      }
      rebuildGrid(true);
    }

    function getUnseatedStudents() {
      const ids = students.map(s => s.id);
      const seated = [];
      for (let i = 0; i < seatsInRow.length; i++) {
        for (let j = 0; j < seatsInRow[i]; j++) {
          if (grid[i][j].studentId) {
            seated.push(grid[i][j].studentId);
          }
        }
      }
      return ids.filter(i => seated.indexOf(i) === -1);
    }

    function findCellWithStudentId(sid) {
      for (let i = 0; i < seatsInRow.length; i++) {
        for (let j = 0; j < seatsInRow[i]; j++) {
          if (grid[i][j].studentId === sid) {
            return grid[i][j];
          }
        }
      }
    }

    function onSelect(gridId) {
      let [gridCell, lastClickedStudentId] = [null, null];

      if (gridId.startsWith("u")) {
        const idx = gridId.split("_")[1];
        lastClickedStudentId = unseated[idx];
      } else {
        const [row, col] = gridId.split("_");
        gridCell = grid[row][col];
        lastClickedStudentId = gridCell.studentId;
      }

      // Case 1: First click => select student and return
      if (!firstClickedStudentId) {
        firstClickedStudentId = lastClickedStudentId;
        renderGrid();
        return;
      }

      // Case 2: Second click after selection. Swap/Move selected student.
      const originCell = findCellWithStudentId(firstClickedStudentId);
      if (lastClickedStudentId) {
        // Two clicks on same student => move to bench
        if (lastClickedStudentId === firstClickedStudentId) {
          if (originCell) {
            originCell.studentId = null;
            changed = [lastClickedStudentId];
          }
        } else {
          if (originCell && gridCell) {
            // Swap between two grid cells
            originCell.studentId = gridCell.studentId;
            gridCell.studentId = firstClickedStudentId;
            changed = [lastClickedStudentId, firstClickedStudentId];
          } else if (originCell) {
            // Swap from grid to bench
            originCell.studentId = lastClickedStudentId;
            changed = [lastClickedStudentId, firstClickedStudentId];
          } else if (gridCell) {
            // Swap from bench to grid
            gridCell.studentId = firstClickedStudentId;
            changed = [lastClickedStudentId, firstClickedStudentId];
          } else {
            console.log("Invalid swap");
          }
        }
      } else {
        if (originCell) {
          originCell.studentId = null;
        }
        gridCell.studentId = firstClickedStudentId;
        changed = [firstClickedStudentId];
      }

      firstClickedStudentId = null;
      renderGrid();
    }

    function saveSeatingPlan() {
      const plan = {
        seatsInRow,
        grid
      }

      $.post(API.save,
        {
          refId: 123,
          refEntityName: "class", 
          jsonContent: JSON.stringify(plan),
          creatorName: "Charra, Johannes",
          isPublic: 1
        },
        () => $('.toast').toast("show")
      );
    }

    function clearGrid() {
      if (getUnseatedStudents().length < students.length && confirm("Sitzordnung leeren?")) {
        rebuildGrid(false);
      }
    }


  </script>
</head>

<body onload="init()">
  <div id="gridModification" class="d-flex justify-content-center w-100 my-2">
    <button id="addRow" class="btn btn-primary mx-2 my-1" onclick="changeRows(1)">Reihe hinzuf√ºgen</button>
    <button id="deleteRow" class="btn btn-primary mx-2 my-1" onclick="changeRows(-1)">Reihe entfernen</button>
  </div>

  <div id="classroom">
  </div>

  <button id="toggleViewButton" class="btn btn-success mx-2 mb-1" onclick="toggleView()">Zur Sch√ºleransicht
    wechseln</button>

  <div id="distribution">
    <button id="clearButton" class="btn btn-primary mx-2 my-1" onclick="fillUnseatedStudents()">Verbleibende SuS
      zuf√§llig verteilen</button>
    <button class="btn btn-warning mx-2 my-1" onclick="clearGrid()">Alle Pl√§tze leeren</button>
    <button class="btn btn-success" onclick="saveSeatingPlan()">Sitzordnung speichern</button>
  </div>

  <div id="unseated" class="m-3 d-flex flex-wrap align-items-start">
  </div>

  <div class="toast mx-4" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body">
      Sitzordnung erfolgreich gespeichert!
    </div>
  </div>

</body>

</html>